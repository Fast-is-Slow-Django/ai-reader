# é˜…è¯»å™¨é¡µé¢å¼€å‘æŒ‡å—

EPUB é˜…è¯»å™¨çš„æ¶æ„å’Œå®ç°æ–‡æ¡£ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
ireader/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ read/
â”‚       â””â”€â”€ [id]/
â”‚           â””â”€â”€ page.tsx              # âœ… é˜…è¯»å™¨é¡µé¢ï¼ˆServer Componentï¼‰
â””â”€â”€ components/
    â””â”€â”€ reader/
        â””â”€â”€ MobileReader.tsx          # â³ é˜…è¯»å™¨ç»„ä»¶ï¼ˆClient Componentï¼‰
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### **åŒå±‚æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app/read/[id]/page.tsx             â”‚
â”‚  (Server Component)                 â”‚
â”‚                                     â”‚
â”‚  - éªŒè¯ç”¨æˆ·ç™»å½•                      â”‚
â”‚  - æŸ¥è¯¢ä¹¦ç±ä¿¡æ¯                      â”‚
â”‚  - éªŒè¯è®¿é—®æƒé™                      â”‚
â”‚  - è·å– file_url                    â”‚
â”‚                                     â”‚
â”‚  â””â”€> ä¼ é€’ props                     â”‚
â”‚       â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ <MobileReader />            â”‚   â”‚
â”‚  â”‚ (Client Component)          â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ - åŠ è½½ EPUB æ–‡ä»¶            â”‚   â”‚
â”‚  â”‚ - æ¸²æŸ“ä¹¦ç±å†…å®¹              â”‚   â”‚
â”‚  â”‚ - å¤„ç†ç”¨æˆ·äº¤äº’              â”‚   â”‚
â”‚  â”‚ - ä¿å­˜é˜…è¯»è¿›åº¦              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

1. **Server Component (page.tsx)**
   - âœ… åœ¨æœåŠ¡ç«¯éªŒè¯æƒé™ï¼ˆå®‰å…¨ï¼‰
   - âœ… å‡å°‘å®¢æˆ·ç«¯ JavaScript
   - âœ… SEO å‹å¥½
   - âœ… æ›´å¿«çš„æ•°æ®è·å–

2. **Client Component (MobileReader.tsx)**
   - âœ… å¤„ç†ç”¨æˆ·äº¤äº’ï¼ˆç¿»é¡µã€ç¼©æ”¾ï¼‰
   - âœ… ä½¿ç”¨ react-reader ç­‰å®¢æˆ·ç«¯åº“
   - âœ… ä¿æŒçŠ¶æ€ï¼ˆè¿›åº¦ã€è®¾ç½®ï¼‰
   - âœ… æµç•…çš„åŠ¨ç”»æ•ˆæœ

---

## ğŸ“„ page.tsx è¯¦è§£

### **æ•°æ®è·å–æµç¨‹**

```typescript
1. è·å– URL å‚æ•° id
   â†“
2. éªŒè¯ç”¨æˆ·ç™»å½•
   â”œâ”€ æˆåŠŸï¼šç»§ç»­
   â””â”€ å¤±è´¥ï¼šredirect('/login?redirectTo=/read/' + id)
   â†“
3. æŸ¥è¯¢ä¹¦ç±ä¿¡æ¯
   - SELECT id, title, file_url, user_id
   - WHERE id = ? AND user_id = ?
   â†“
4. éªŒè¯æŸ¥è¯¢ç»“æœ
   â”œâ”€ ä¹¦ç±å­˜åœ¨ && å±äºå½“å‰ç”¨æˆ·ï¼šç»§ç»­
   â””â”€ å¤±è´¥ï¼šredirect('/dashboard')
   â†“
5. éªŒè¯ file_url
   â”œâ”€ å­˜åœ¨ï¼šæ¸²æŸ“é˜…è¯»å™¨
   â””â”€ ä¸å­˜åœ¨ï¼šredirect('/dashboard')
```

### **å…³é”®ä»£ç **

```typescript
export default async function ReadPage({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  const { id } = await params
  const supabase = await createClient()

  // éªŒè¯ç”¨æˆ·
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/login?redirectTo=/read/' + id)

  // æŸ¥è¯¢ä¹¦ç±
  const { data: book } = await supabase
    .from('books')
    .select('id, title, file_url, user_id')
    .eq('id', id)
    .eq('user_id', user.id)  // é‡è¦ï¼šåŒé‡éªŒè¯
    .single()

  if (!book) redirect('/dashboard')

  // æ¸²æŸ“é˜…è¯»å™¨
  return <MobileReader url={book.file_url} title={book.title} />
}
```

### **å®‰å…¨ç‰¹æ€§**

- âœ… **åŒé‡æƒé™éªŒè¯**
  - RLS ç­–ç•¥ï¼ˆæ•°æ®åº“å±‚ï¼‰
  - `.eq('user_id', user.id)`ï¼ˆä»£ç å±‚ï¼‰

- âœ… **é‡å®šå‘å¤„ç†**
  - æœªç™»å½• â†’ `/login?redirectTo=/read/[id]`
  - æ— æƒé™ â†’ `/dashboard`

- âœ… **é”™è¯¯å¤„ç†**
  - ä¹¦ç±ä¸å­˜åœ¨ â†’ é‡å®šå‘
  - file_url ç¼ºå¤± â†’ é‡å®šå‘
  - æŸ¥è¯¢å¤±è´¥ â†’ é‡å®šå‘

---

## ğŸ¨ MobileReader.tsx è¯¦è§£

### **å½“å‰çŠ¶æ€ï¼ˆç©ºå£³ï¼‰**

```tsx
export default function MobileReader({
  url,
  title,
  bookId,
}: {
  url: string
  title: string
  bookId: string
}) {
  return (
    <div className="flex-1 flex flex-col h-full">
      {/* é¡¶éƒ¨å·¥å…·æ  */}
      <header>
        <h1>{title}</h1>
        <span>è¿›åº¦: 0%</span>
      </header>

      {/* é˜…è¯»å™¨ä¸»ä½“ */}
      <main>
        {loading ? (
          <Loader2 />
        ) : (
          <div>é˜…è¯»å™¨å¼€å‘ä¸­...</div>
        )}
      </main>

      {/* åº•éƒ¨å·¥å…·æ  */}
      <footer>
        <button>ä¸Šä¸€é¡µ</button>
        <span>Page 1 / 1</span>
        <button>ä¸‹ä¸€é¡µ</button>
      </footer>
    </div>
  )
}
```

### **å¸ƒå±€ç»“æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header (Sticky)                â”‚
â”‚  ğŸ“– ä¹¦å              è¿›åº¦: 50% â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚                                 â”‚
â”‚          é˜…è¯»å™¨å†…å®¹åŒº            â”‚
â”‚      ï¼ˆEPUB æ¸²æŸ“åŒºåŸŸï¼‰           â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Footer (Sticky)                â”‚
â”‚  [ä¸Šä¸€é¡µ]  Page 5/100  [ä¸‹ä¸€é¡µ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **å¾…å®ç°åŠŸèƒ½**

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| EPUB åŠ è½½ | é«˜ | ä½¿ç”¨ epubjs |
| ç¿»é¡µåŠŸèƒ½ | é«˜ | å·¦å³ç¿»é¡µ |
| è¿›åº¦ä¿å­˜ | é«˜ | ä¿å­˜åˆ°æ•°æ®åº“ |
| å­—ä½“å¤§å° | ä¸­ | å¯è°ƒæ•´ |
| ä¸»é¢˜åˆ‡æ¢ | ä¸­ | æ—¥é—´/å¤œé—´ |
| ä¹¦ç­¾åŠŸèƒ½ | ä¸­ | æ ‡è®°ä½ç½® |
| é«˜äº®ç¬”è®° | ä½ | åˆ’çº¿ã€ç¬”è®° |
| AI è§£é‡Š | ä½ | é€‰ä¸­æ–‡å­—è§£é‡Š |

---

## ğŸ¯ ä½¿ç”¨æµç¨‹

### **ç”¨æˆ·è§†è§’**

```
1. ç”¨æˆ·åœ¨ä¹¦æ¶ç‚¹å‡»ä¹¦ç±
   â†“
2. è·³è½¬åˆ° /read/[book-id]
   â†“
3. æœåŠ¡ç«¯éªŒè¯æƒé™
   â†“
4. æ¸²æŸ“é˜…è¯»å™¨é¡µé¢
   â†“
5. å®¢æˆ·ç«¯åŠ è½½ EPUB
   â†“
6. ç”¨æˆ·å¼€å§‹é˜…è¯»
```

### **æŠ€æœ¯æµç¨‹**

```
1. Next.js è·¯ç”±ï¼š/read/[id]
   â†“
2. Server Component æ‰§è¡Œ
   - è·å– params.id
   - æŸ¥è¯¢æ•°æ®åº“
   - éªŒè¯æƒé™
   â†“
3. è¿”å› HTMLï¼ˆåŒ…å«åˆå§‹æ•°æ®ï¼‰
   â†“
4. å®¢æˆ·ç«¯æ¿€æ´» (hydrate)
   â†“
5. MobileReader ç»„ä»¶æŒ‚è½½
   â†“
6. useEffect åŠ è½½ EPUB
   â†“
7. æ¸²æŸ“é˜…è¯»å™¨ç•Œé¢
```

---

## ğŸ”§ Props ä¼ é€’

### **page.tsx â†’ MobileReader**

```typescript
<MobileReader
  url={book.file_url}      // EPUB æ–‡ä»¶ URL
  title={book.title}       // ä¹¦ç±æ ‡é¢˜
  bookId={book.id}         // ä¹¦ç± IDï¼ˆç”¨äºä¿å­˜è¿›åº¦ï¼‰
/>
```

### **ä¸ºä»€ä¹ˆä¼ è¿™ä¸‰ä¸ªï¼Ÿ**

1. **url** - å¿…éœ€
   - EPUB æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
   - ç”¨äºåŠ è½½ä¹¦ç±å†…å®¹

2. **title** - æ˜¾ç¤ºç”¨
   - é¡¶éƒ¨å·¥å…·æ æ˜¾ç¤º
   - é¡µé¢æ ‡é¢˜

3. **bookId** - åŠŸèƒ½ç”¨
   - ä¿å­˜é˜…è¯»è¿›åº¦åˆ°æ•°æ®åº“
   - ä¿å­˜ä¹¦ç­¾ã€ç¬”è®°
   - æ ‡è¯†å”¯ä¸€ä¹¦ç±

---

## ğŸ“Š å…ƒæ•°æ®ç”Ÿæˆ

### **åŠ¨æ€é¡µé¢æ ‡é¢˜**

```typescript
export async function generateMetadata({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  // æŸ¥è¯¢ä¹¦ç±æ ‡é¢˜
  const { data: book } = await supabase
    .from('books')
    .select('title')
    .eq('id', id)
    .single()

  return {
    title: `${book.title} - AI-Reader`,
    description: `æ­£åœ¨é˜…è¯»ã€Š${book.title}ã€‹`,
  }
}
```

**æ•ˆæœï¼š**
- æµè§ˆå™¨æ ‡ç­¾ï¼š`è¥¿æ¸¸è®° - AI-Reader`
- SEO å‹å¥½

---

## ğŸ” è°ƒè¯•æŠ€å·§

### **éªŒè¯æ•°æ®ä¼ é€’**

åœ¨ `MobileReader.tsx` ä¸­ä¸´æ—¶æ·»åŠ ï¼š

```tsx
useEffect(() => {
  console.log('ğŸ“– é˜…è¯»å™¨ Props:')
  console.log('  URL:', url)
  console.log('  Title:', title)
  console.log('  Book ID:', bookId)
}, [url, title, bookId])
```

### **æµ‹è¯•æƒé™éªŒè¯**

1. **æ­£å¸¸æµç¨‹**
```
è®¿é—® /read/[è‡ªå·±çš„ä¹¦ç±ID]
â†’ æ­£å¸¸æ˜¾ç¤ºé˜…è¯»å™¨
```

2. **æœªç™»å½•**
```
è®¿é—® /read/[ä»»æ„ID]
â†’ é‡å®šå‘åˆ° /login?redirectTo=/read/[ID]
```

3. **æ— æƒé™**
```
è®¿é—® /read/[åˆ«äººçš„ä¹¦ç±ID]
â†’ é‡å®šå‘åˆ° /dashboard
```

### **æŸ¥çœ‹ Server Component æ—¥å¿—**

æœåŠ¡ç«¯æ—¥å¿—åœ¨ç»ˆç«¯æ˜¾ç¤ºï¼š

```bash
npm run dev

# è®¿é—®é˜…è¯»å™¨é¡µé¢æ—¶ä¼šçœ‹åˆ°
æŸ¥è¯¢ä¹¦ç±å¤±è´¥: { code: 'PGRST116', ... }  # å¦‚æœå¤±è´¥
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q: è®¿é—®é˜…è¯»å™¨æ˜¾ç¤º 404

**åŸå› **ï¼šNext.js åŠ¨æ€è·¯ç”±æœªæ­£ç¡®è¯†åˆ«

**è§£å†³**ï¼š
1. æ£€æŸ¥æ–‡ä»¶å¤¹åæ˜¯å¦ä¸º `[id]`ï¼ˆåŒ…å«æ–¹æ‹¬å·ï¼‰
2. é‡å¯å¼€å‘æœåŠ¡å™¨

---

### Q: é¡µé¢ä¸€ç›´é‡å®šå‘

**åŸå› **ï¼šæŸ¥è¯¢å¤±è´¥æˆ–æƒé™é—®é¢˜

**è§£å†³**ï¼š
1. æ£€æŸ¥ä¹¦ç± ID æ˜¯å¦æ­£ç¡®
2. æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—
3. æ£€æŸ¥ Supabase RLS ç­–ç•¥

---

### Q: Props ä¼ é€’å¤±è´¥

**åŸå› **ï¼šServer/Client Component è¾¹ç•Œé—®é¢˜

**è§£å†³**ï¼š
1. ç¡®ä¿ MobileReader æœ‰ `'use client'`
2. Props å¿…é¡»å¯åºåˆ—åŒ–ï¼ˆä¸èƒ½ä¼ å‡½æ•°ï¼‰

---

## ğŸ“‹ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### **Phase 1: åŸºç¡€é˜…è¯»å™¨** â³

```typescript
// é›†æˆ react-reader
import { ReactReader } from 'react-reader'

<ReactReader
  url={url}
  location={location}
  locationChanged={setLocation}
/>
```

### **Phase 2: è¿›åº¦ä¿å­˜** â³

```typescript
// ä¿å­˜è¿›åº¦åˆ°æ•°æ®åº“
const saveProgress = async (location: string) => {
  await supabase
    .from('reading_progress')
    .upsert({
      book_id: bookId,
      location: location,
    })
}
```

### **Phase 3: å·¥å…·æ ** â³

```typescript
// å­—ä½“å¤§å°ã€ä¸»é¢˜åˆ‡æ¢
const [fontSize, setFontSize] = useState(16)
const [theme, setTheme] = useState('light')
```

### **Phase 4: é«˜çº§åŠŸèƒ½** â³

```typescript
// ä¹¦ç­¾ã€ç¬”è®°ã€AI è§£é‡Š
```

---

## âœ… æ£€æŸ¥æ¸…å•

å½“å‰é˜¶æ®µå®Œæˆé¡¹ï¼š

- [x] åˆ›å»º `/read/[id]` è·¯ç”±
- [x] å®ç°æƒé™éªŒè¯
- [x] æŸ¥è¯¢ä¹¦ç±ä¿¡æ¯
- [x] ä¼ é€’ props åˆ°é˜…è¯»å™¨ç»„ä»¶
- [x] åˆ›å»º MobileReader ç©ºå£³
- [x] å®ç°åŠ è½½çŠ¶æ€
- [x] è®¾è®¡å¸ƒå±€ç»“æ„

å¾…å®ç°ï¼š

- [ ] é›†æˆ EPUB.js æˆ– react-reader
- [ ] å®ç°ç¿»é¡µåŠŸèƒ½
- [ ] ä¿å­˜é˜…è¯»è¿›åº¦
- [ ] å­—ä½“å¤§å°è°ƒæ•´
- [ ] ä¸»é¢˜åˆ‡æ¢
- [ ] ä¹¦ç­¾åŠŸèƒ½
- [ ] é«˜äº®å’Œç¬”è®°
- [ ] AI è§£é‡Šé›†æˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¹¦æ¶é¡µé¢](./DASHBOARD_PAGE.md)
- [Server Actions](./DASHBOARD_ACTIONS.md)
- [React Reader æ–‡æ¡£](https://github.com/gerhardsletten/react-reader)

---

**å½“å‰çŠ¶æ€**: âœ… åŸºç¡€æ¶æ„å®Œæˆï¼Œå‡†å¤‡é›†æˆ EPUB é˜…è¯»å™¨
